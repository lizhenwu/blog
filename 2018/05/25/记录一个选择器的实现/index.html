<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 记录一个选择器的实现 · blog | windmill_</title><meta name="description" content="记录一个选择器的实现 - windmill_"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/blog/favicon.png"><link rel="stylesheet" href="/blog/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="https://lizhenwu.github.io/blog/atom.xml" title="blog | windmill_"></head><body><div class="wrap"><header><a href="/blog/" class="logo-link"><img src="/blog/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/blog/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/blog/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://weibo.com/u/3196026755" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/lizhenwu" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/blog/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">记录一个选择器的实现</h1><div class="post-info">2018年5月25日</div><div class="post-content"><p>看《javascript框架设计》这本书的时候发现作者写的一个选择器的实现，其中有一些<code>DOM API</code>的使用感觉很有意思。<br><a id="more"></a></p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>首先，这应该是一个比较hack并且兼容性强的选择器实现方式。<br>摘录自《javascript框架设计》p135的选择器源码<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 兼容ie6</span></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">_$</span>(<span class="params">query</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> res = [];</div><div class="line">    <span class="keyword">if</span>(<span class="built_in">document</span>.querySelector) &#123;</div><div class="line">        res = <span class="built_in">document</span>.querySelectorAll(query);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="keyword">var</span> firstStyleSheet = <span class="built_in">document</span>.styleSheets[<span class="number">0</span>] || <span class="built_in">document</span>.createStyleSheet();</div><div class="line">        query = query.split(<span class="string">','</span>);</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; query.length; i++) &#123;</div><div class="line">            <span class="comment">// addRule是特定于IE的方法</span></div><div class="line">            firstStyleSheet.addRule(query[i], <span class="string">'Hack: ie'</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = <span class="built_in">document</span>.all.length; i &lt; len; i++) &#123;</div><div class="line">            <span class="keyword">var</span> item = <span class="built_in">document</span>.all[i];</div><div class="line">            item.currentStyle.Hack &amp;&amp; res.push(item);</div><div class="line">        &#125;</div><div class="line">        firstStyleSheet.removeRule(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">var</span> ret = [];</div><div class="line">    <span class="keyword">for</span>(<span class="keyword">var</span> i = <span class="number">0</span>, len = res.length; i &lt; len; i++) &#123;</div><div class="line">        ret.push(res[i]);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> ret;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h3><p>实际测试的时候发现会出错</p>
<p><img src="https://i.loli.net/2018/05/18/5afe484028599.png" alt="图"></p>
<p>因为<code>addRule</code>是IE特有的方法，然后我在IE11上测试了一下是成功的，然后把<code>addRule</code>替换成mdn上看到的另一个方法<code>insertRule</code>，两者的参数规则不同，前者是传入三个参数: 第一个选择器字符串，第二个用冒号分割的css属性值字符串，第三个是一个数字表示插入规则的位置（可省略）,后者的参数是一个字符串类型的css规则（和css文件里写法一样），第二个是插入位置数字（可省略）。</p>
<p>这时候问题就来了，在同一个网站页面上使用<code>insertRule</code>插入css规则时，IE11不会报错但Chrome会报错</p>
<p>于是我在自己的网站上又用Chrome测试了一下发现是成功的，也就是说在chrome上操作的<code>CSSStyleSheet</code>必须是同源才能插入css规则。而在IE11上非同源的<code>CSSStyleSheet</code>也是可以插入的</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>这个方法中除了上面提过的的<code>CSSStyleSheet</code>接口和它的<code>insertRule</code>方法以外，还有<code>document.createStyleSheet</code>方法，<code>document.all</code>,<code>Element.currentStyle</code>。</p>
<p>其中<code>document.createStyleSheet</code>和<code>Element.currentStyle</code>都是IE特有的API，而<code>document.all</code>虽然也是IE的，但其他浏览器也有不同程度的支持，它返回页面中所有html标签的集合，但是在chrome中有这样的现象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span>(!<span class="built_in">document</span>.all) &#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'no surpport for document.all'</span>); <span class="comment">// 控制台输出 no surpport for document.all</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>但它确实是可以使用的，所以不能这样来检测是否支持，倒是可以用来检测当前浏览器是否IE。</p>
<p>然后，这个选择器方法的逻辑其实很简单，就是在<code>styleSheet</code>给要查找的元素添加一条css规则，然后遍历页面上所有元素看它是否有刚刚添加的那条css属性，有的话就是要选择的元素。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>[1] <a href="https://developer.mozilla.org/en-US/docs/Web/API/StyleSheet" target="_blank" rel="external">MDN</a></p>
<hr>
<p>IE可真难用啊</p>
</div></article></div></main><footer><div class="paginator"><a href="/blog/2018/05/25/从vuex源码探索如何resetState/" class="prev">上一篇</a><a href="/blog/2018/05/07/面试相关问题/" class="next">下一篇</a></div><div class="copyright"><p>© 2017 - 2018 <a href="https://lizhenwu.github.io/blog">windmill_</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script></body></html>